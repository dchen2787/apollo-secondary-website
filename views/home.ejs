<!--
<%- include("./partials/header"); -%>
<div id="view-shadow-slots">
<% const isConfirmed = (typeof confirmed !== 'undefined' && confirmed); %>
<% if(errM){%>
   <div class="alert alert-success">
     <h6 class="mb-0"><%=errM%>
       <button type="button" class="close" data-dismiss="alert" aria-label="Close">
         <span aria-hidden="true">&times;</span>
       </button>
     </h6>
   </div>
 <%}%>
<% if (controls && controls.matchingLocked === true) { %>
 <h1>Your Matches</h1>
 <% var count = 0 %>
 <% slots.forEach(function(slot){ %>
   <% if(slot.studentEmail && slot.studentEmail == user.email){%>
     <% count++; %>
     <hr />
     <div class="row">
        <div class="col-12 col-md-9">
         <%= slot.physName %>, <%=slot.physSpecialty %> <br />
         <%= slot.dDate %>, <%= slot.timeStart %> to <%= slot.timeEnd %> <br />
         <%= slot.location %> <br />
         <% if(slot.notes){ %>
          <p class="italics">  Notes: <%= slot.notes %><br /></p>
         <% }%>
       </div>
       <% if (!isConfirmed) { %>
          <div class="col-12 col-md-3">
            <form action="/unclaim" method="post">
              <input type="hidden" name="userEmail" value="<%=user.email%>">
              <input type="hidden" name="slotId" value="<%=slot._id%>">
              <br/>
              <button type="submit" name="button" class="btn">Remove</button>
            </form>
          </div>
      <% } %>
     </div>
   <% } %>

 <% }) %>
 <hr />
 <br /><br />

 <h5>To confirm that you are willing and able to attend all the slots above, press this button. Please remember to check date and location information carefully. If you are unable to attend any of the slots above or have any questions about your slots, instead contact the Apollo Team via email immediately. </h5>
 <br /> 

 <!-- future todo: make confirm form disappear after student has confirmed once ( done :) ) --> 
 <% if (isConfirmed) { %>
   <p>I can attend all slots listed above:</p>
   <button type="button" class="btn" disabled>Slots confirmed</button>
 <% } else { %>
   <form action="/confirm" method="post">
     <input type="hidden" name="userEmail" value="<%=user.email%>">
     <p>I can attend all slots listed above:</p>
     <button type="submit" name="button" class="btn">Confirm</button>
   </form>
 <% } %>
 
 <!-- <h4>Your matches are locked at this time. If you have any questions or concerns, please contact apolloyimde@gmail.com.</h4> -->


<% } else { %>
<h1>Your Matches</h1>
<% var count = 0 %>
<% slots.forEach(function(slot){ %>
 <% if(slot.studentEmail && slot.studentEmail == user.email){%>
   <% count++; %>
   <hr />
   <div class="row">
     <div class="col-12 col-md-9">
       <%= slot.physName %>, <%=slot.physSpecialty %> <br />
       <%= slot.dDate %>, <%= slot.timeStart %> to <%= slot.timeEnd %> <br />
       <%= slot.location %> <br />
       <% if(slot.notes){ %>
       <p class="italics">  Notes: <%= slot.notes %><br /></p>
       <% }%>
     </div>
     <div class="col-12 col-md-3">
       <form action="/unclaim" method="post">
         <input type="hidden" name="userEmail" value="<%=user.email%>">
         <input type="hidden" name="slotId" value="<%=slot._id%>">
         <br/>
         <button type="submit" name="button" class="btn">Remove</button>
       </form>
     </div>
   </div>
 <% } %>

<% }) %>
<hr /><br />
<% if (count < maxSlots) { %>
 <% if (controls && controls.PCPonly === true) { %>
   <h4>*PCP-only phase is active. You can browse all slots, but you may only claim Primary Care slots right now.</h4>
 <% } else if (maxSlots === 2) { %>
   <h4>*You may claim up to 2 slots for this phase of the Match. Any matches listed above are saved and Apollo will confirm your slots via email after the Match period.</h4>
 <% } else { %>
   <h4>*You may claim an unlimited number of slots at this time. Any matches listed above are saved and Apollo will confirm your slots via email after the Match period.</h4>
 <% } %>
<% } else { %>
 <% if (maxSlots === 2) { %>
   <h4>*You have reached the maximum of 2 slots for this phase of the Match.</h4>
 <% } else { %>
   <h4>*You have the maximum number of matches at this time. Your above matches are saved and Apollo will confirm your slots via email after the Match period.</h4>
 <% } %>
<% } %>
<br /><br /><br /><br />

<%
 // sorted list of specialties from the slots rendered
 var specialties = [];
 slots.forEach(function(s){
   if (s.physSpecialty) {
     const spec = (s.physSpecialty || '').trim();
     if (specialties.indexOf(spec) === -1) specialties.push(spec);
   }
 });
 specialties.sort();
%>

<% if (!(controls && controls.matchingLocked)) { %>

 <h1>Shadow Slots</h1><br/>
 <!-- Filter Bar -->
 <div style="margin: 0.5rem 0 1rem; padding: 0.75rem; background: #f8f8f8; border: 1px solid #ccc; border-radius:6px;">
   <div class="row">
     <div class="col-12 col-md-4" style="margin-bottom:.5rem;">
       <input id="slotSearch" class="form-control" placeholder="Search by physician or specialty">
     </div>
 
     <div class="col-12 col-md-5" style="margin-bottom:.5rem;">
       <div class="dropdown">
         <button class="btn btn-light dropdown-toggle w-100" type="button" id="specDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
           Specialties (multi-select)
         </button>
         <div class="dropdown-menu w-100 p-2" aria-labelledby="specDropdown" style="max-height: 260px; overflow:auto;">
           <label class="dropdown-item mb-1">
             <input type="checkbox" id="specAll" checked> <strong>All specialties</strong>
           </label>
           <div class="dropdown-divider"></div>
           <% specialties.forEach(function(spec){ %>
             <label class="dropdown-item mb-1">
               <input type="checkbox" class="spec-option" value="<%= spec %>">
               <span><%= spec %></span>
             </label>
           <% }) %>
         </div>
       </div>
       <small id="specCountHint" style="opacity:.7; display:block; margin-top:.25rem;">All specialties selected</small>
     </div>
 
     <div class="col-6 col-md-2 d-flex align-items-center" style="margin-bottom:.5rem;">
       <label class="mb-0">
         <input id="onlyUnclaimed" type="checkbox" style="margin-right:6px;">
         Only show unmatched slots
       </label>
     </div>
 
     <div class="col-6 col-md-1 d-flex align-items-center" style="margin-bottom:.5rem;">
       <button id="resetFilters" type="button" class="btn btn-light w-100">Reset</button>
     </div>
   </div>
 </div>
 
 <!-- End -->
 <% const pcpOnly = controls && controls.PCPonly === true; %>
 
 <!-- <p>Please remember, all slots currently listed below fall under the category of Primary Care. More specialty slots will be available starting Wednesday, 10/20.</p><br/><br/> -->
 <!-- <div class="container"> -->
   <div class="row chart-titles">
     <div class="col col-12 col-lg-2">
       Physician
     </div>
     <div class="col col-12 col-lg-2">
       Date
     </div>
     <div class="col col-12 col-lg-2">
       Time
     </div>
     <div class="col col-12 col-lg-2">
       Location
     </div>
     <div class="col col-12 col-lg-2">
       Notes
     </div>
     <div class="col col-12 col-lg-2">
       Matched?
     </div>
   </div>
 <hr>
 <% slots.forEach(function(slot){ %>
   <!-- !controls.PCPonly ||  -->
   <!-- slot.physSpecialty.includes("Primary Care") -->
   <% if(true){%>
 
 <div class="slot-row"
      data-phys="<%= (slot.physName || '').toLowerCase() %>"
      data-spec="<%= (slot.physSpecialty || '').toLowerCase() %>"
      data-filled="<%= (slot.studentEmail && slot.studentEmail.length>0) ? 'true' : 'false' %>">
 
   <div class="row">
     <div class="col col-12 col-lg-2">
       <%= slot.physName %>, <%=slot.physSpecialty %>
     </div>
     <div class="col col-12 col-lg-2"><%= slot.dDate %></div>
     <div class="col col-12 col-lg-2"><%= slot.timeStart %> to <%= slot.timeEnd %></div>
     <div class="col col-12 col-lg-2"><%= slot.location %></div>
     <div class="col col-12 col-lg-2"><%= slot.notes %></div>
     <div class="col col-12 col-lg-2">
       <% var btnProp = null; %>
       <% count >= maxSlots ? btnProp = "disabled" : null %>
 
       <% if (slot.studentEmail && slot.studentEmail.length>0) { %>
         <p class="italics">Filled</p>
       <% } else { %>
         <% if (pcpOnly && !slot.isPCP) { %>
           <button class="btn" disabled title="PCP-only Phase">Match</button>
           <small style="opacity:.7; margin-left:.5rem;">(PCP-only active)</small>
         <% } else { %>
           <form action="/claim" method="post">
             <input type="hidden" name="userFName" value="<%=user.fName%>">
             <input type="hidden" name="userLName" value="<%=user.lName%>">
             <input type="hidden" name="userEmail" value="<%=user.email%>">
             <input type="hidden" name="slotId" value="<%=slot._id%>">
             <button type="submit" name="button" class="btn <%=btnProp%>" <%=btnProp%>>Match</button>
           </form>
         <% } %>
       <% } %>
     </div>
   </div>
 
   <hr />
 </div>
 
 
 <% }}) %>
 <%  } %>
<% } %>

 </div>


<!-- filter logic -->
<script>
(function(){
 const q  = s => document.querySelector(s);
 const qa = s => Array.from(document.querySelectorAll(s));

 // inputs
 const search     = q('#slotSearch');
 const unclaimed  = q('#onlyUnclaimed');
 const resetBtn   = q('#resetFilters');

 // specialty dropdown
 const specAll    = q('#specAll');
 const specChecks = qa('.spec-option');
 const specHint   = q('#specCountHint');

 // rows
 const rows = qa('.slot-row');

 // keep dropdown open when clicking inside
 document.querySelectorAll('.dropdown-menu').forEach(menu => {
   menu.addEventListener('click', e => e.stopPropagation());
 });

 function selectedSpecsLower() {
   const picked = specChecks.filter(c => c.checked).map(c => (c.value || '').toLowerCase());
   return picked;
 }

 function updateSpecHint() {
   const picked = specChecks.filter(c => c.checked).length;
   if (specAll.checked || picked === 0 || picked === specChecks.length) {
     specHint.textContent = 'All specialties selected';
   } else {
     specHint.textContent = picked + ' specialty(ies) selected';
   }
 }

 function applyFilters() {
   const term = (search?.value || '').trim().toLowerCase();
   const wantOnlyUnclaimed = !!(unclaimed && unclaimed.checked);
   const pickedSpecs = specAll && specAll.checked ? [] : selectedSpecsLower(); // empty => all

   rows.forEach(row => {
     const name = row.dataset.phys || '';
     const spec = row.dataset.spec || '';
     const isFilled = row.dataset.filled === 'true';

     let ok = true;

     // text search
     if (term) {
       ok = name.includes(term) || spec.includes(term);
     }

     // specialties (if any picked)
     if (ok && pickedSpecs.length > 0) {
       ok = pickedSpecs.includes(spec);
     }

     // only unclaimed
     if (ok && wantOnlyUnclaimed) {
       ok = !isFilled;
     }

     row.style.display = ok ? '' : 'none';
   });
 }

 // wire up events
 search?.addEventListener('input', applyFilters);
 unclaimed?.addEventListener('change', applyFilters);

 // spec "All" checkbox behavior
 specAll?.addEventListener('change', () => {
   if (specAll.checked) {
     specChecks.forEach(c => c.checked = false);
   }
   updateSpecHint();
   applyFilters();
 });

 // individual spec checkboxes
 specChecks.forEach(c => {
   c.addEventListener('change', () => {
     if (specChecks.some(x => x.checked)) {
       specAll.checked = false;
     } else {
       specAll.checked = true;
     }
     updateSpecHint();
     applyFilters();
   });
 });

 // reset button
 resetBtn?.addEventListener('click', () => {
   if (search) search.value = '';
   if (unclaimed) unclaimed.checked = false;
   if (specAll) specAll.checked = true;
   specChecks.forEach(c => c.checked = false);
   updateSpecHint();
   applyFilters();
 });

 // initial render
 updateSpecHint();
 applyFilters();
})();
</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
 $(function () {
   $('#specDropdown').dropdown(); // initialize BS4 dropdown
 });
</script>
<%- include("./partials/footer"); -%>
-->
<%- include("./partials/header"); -%>

<style>
  .page-hero { display:flex; align-items:center; gap:14px; margin:18px 0 8px; }
  .avatar { width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#eef4ff;color:#3353d1;font-weight:700; }
  .badge-soft { background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 10px; font-size:12px; }
  .pill-nonpcp { display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; background:#fef3c7; color:#92400e; }
  .slot-card { border-radius:18px; padding:14px; background:#fff; margin-bottom:12px; box-shadow:0 4px 12px rgba(0,0,0,.07); }
  .slot-card .head { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .muted { color:#6b7280; }
  .btn-soft { background:#111827; color:#fff; border:none; border-radius:12px; padding:8px 14px; }
  .btn-soft[disabled] { opacity:.55; cursor:not-allowed; }
  .btn-ghost { background:#f3f4f6; border:none; border-radius:12px; padding:8px 14px; }
  .alert { border-radius:14px; padding:10px 12px; margin:8px 0; }
  .alert-info { background:#eff6ff; color:#1d4ed8; }
  .alert-success { background:#ecfdf5; color:#065f46; }
  .alert-warning { background:#fff7ed; color:#9a3412; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .searchbar { border-radius:12px; border:1px solid #e5e7eb; padding:10px 12px; width:100%; max-width:420px; }
  select[multiple] { min-width:220px; min-height:110px; border-radius:10px; border:1px solid #e5e7eb; padding:8px; }
  label.checkbox { display:flex; align-items:center; gap:8px; }
</style>

<div class="container">

  <% if (errM && errM.length) { %>
    <div class="alert alert-info"><%= errM %></div>
  <% } %>

  <% if (controls && controls.matchingLocked) { %>
    <div class="alert alert-warning">Matching is currently locked. You can review/remove your matches but cannot add new ones.</div>
  <% } %>

  <% if (confirmed) { %>
    <div class="alert alert-success">You have confirmed your slots.</div>
  <% } %>

  <% if (controls && controls.PCPonly) { %>
    <div class="alert alert-info">PCP‑only mode is ON. You can only claim primary‑care slots right now.</div>
  <% } %>

  <% 
    var u = user || {};
    var uf = u.fName || '';
    var ul = u.lName || '';
    var ue = u.email || '';
    var initials = ((uf && uf[0]) || '') + ((ul && ul[0]) || '');
  %>

  <!-- Hero -->
  <div class="page-hero">
    <div class="avatar"><%= (initials || 'U').toUpperCase() %></div>
    <div>
      <div class="muted" style="font-size:14px;">Welcome</div>
      <h1 style="margin:0;"><%= uf ? uf : (ue || "Student") %></h1>
    </div>
    <div style="margin-left:auto;">
      <% if (!confirmed && ue) { %>
        <form action="/confirm" method="post">
          <input type="hidden" name="userEmail" value="<%= ue %>">
          <button class="btn-soft">Confirm My Slots</button>
        </form>
      <% } %>
    </div>
  </div>

  <!-- Your matches -->
  <h2 style="margin:16px 0 8px;">Your Matches</h2>
  <%
    var mySlots = [];
    (slots || []).forEach(function(s){ if (s.studentEmail === ue) mySlots.push(s); });
    if (mySlots.length === 0) { %>
      <div class="muted" style="margin-bottom:12px;">You haven’t claimed any slots yet.</div>
  <% } %>

  <% mySlots.forEach(function(slot){ 
       var sp = (slot.physSpecialty || '').trim();
       var isPCP = (sp === 'Family Medicine (PCP)' || sp === 'Primary Care');
  %>
    <div class="slot-card">
      <div class="head">
        <strong><%= slot.physName || '—' %></strong>
        <% if (sp) { %><span class="badge-soft"><%= sp %></span><% } %>
        <% if (!isPCP && sp) { %><span class="pill-nonpcp">Non‑PCP</span><% } %>
      </div>
      <div class="muted" style="margin:6px 0;">
        <strong><%= slot.dDate || '-' %></strong> • <%= (slot.timeStart || '-') %> to <%= (slot.timeEnd || '-') %> • <%= slot.location || '-' %>
      </div>
      <div class="muted"><%= (slot.notes && slot.notes.trim()) ? slot.notes : '—' %></div>

      <div style="margin-top:10px;">
        <form action="/unclaim" method="post" style="display:inline;">
          <input type="hidden" name="userEmail" value="<%= ue %>">
          <input type="hidden" name="slotId" value="<%= slot._id %>">
          <button type="submit" class="btn-ghost">Remove</button>
        </form>
      </div>
    </div>
  <% }); %>

  <!-- Browse with filters -->
  <h2 style="margin:20px 0 8px;">Browse Slots</h2>

  <%
    var specsSet = {};
    (slots || []).forEach(function(s){
      var sp = (s.physSpecialty || '').trim();
      if (sp) specsSet[sp] = true;
    });
    var specialties = Object.keys(specsSet).sort();
    var matchingLocked = !!(controls && controls.matchingLocked);
    var PCPonly = !!(controls && controls.PCPonly);
  %>

  <div class="controls" style="margin-bottom:10px;">
    <input id="search" class="searchbar" placeholder="Search by physician, specialty, location, or notes…">
    <div>
      <label class="muted" style="display:block; font-size:12px; margin-bottom:4px;">Filter by specialty</label>
      <select id="specFilter" multiple>
        <% specialties.forEach(function(sp){ %>
          <option value="<%= sp %>"><%= sp %></option>
        <% }); %>
      </select>
    </div>
    <label class="checkbox">
      <input id="onlyOpen" type="checkbox" checked>
      <span>Only show not claimed</span>
    </label>
  </div>

  <div id="slotList">
    <% (slots || []).forEach(function(slot){ 
         var sp = (slot.physSpecialty || '').trim();
         var isPCP = (sp === 'Family Medicine (PCP)' || sp === 'Primary Care');

         var claimDisabledReason =
           confirmed ? "You have already confirmed."
         : matchingLocked ? "Matching is locked."
         : (PCPonly && !isPCP) ? "PCP‑only is active."
         : null;

         var claimedState =
           slot.studentEmail ? (slot.studentEmail === ue ? "me" : "other") : "no";
    %>
      <div class="slot-card searchable"
           data-search="<%= [slot.physName || '', sp || '', slot.location || '', slot.notes || ''].join(' ').toLowerCase() %>"
           data-spec="<%= sp %>"
           data-claimed="<%= claimedState %>">
        <div class="head">
          <strong><%= slot.physName || '—' %></strong>
          <% if (sp) { %><span class="badge-soft"><%= sp %></span><% } %>
          <% if (!isPCP && sp) { %><span class="pill-nonpcp">Non‑PCP</span><% } %>
        </div>

        <div class="muted" style="margin:6px 0;">
          <strong><%= slot.dDate || '-' %></strong> • <%= (slot.timeStart || '-') %> to <%= (slot.timeEnd || '-') %> • <%= slot.location || '-' %>
        </div>
        <div class="muted"><%= (slot.notes && slot.notes.trim()) ? slot.notes : '—' %></div>

        <div style="margin-top:10px;">
          <% if (!slot.studentEmail) { %>
            <form action="/claim" method="post" style="display:inline;">
              <input type="hidden" name="userEmail" value="<%= ue %>">
              <input type="hidden" name="userFName" value="<%= uf %>">
              <input type="hidden" name="userLName" value="<%= ul %>">
              <input type="hidden" name="slotId" value="<%= slot._id %>">
              <button type="submit" class="btn-soft"
                <% if (claimDisabledReason) { %> disabled title="<%= claimDisabledReason %>" <% } %>>
                Claim
              </button>
            </form>
            <% if (claimDisabledReason) { %>
              <span class="muted" style="margin-left:8px;"><%= claimDisabledReason %></span>
            <% } %>
          <% } else { %>
            <% if (slot.studentEmail === ue) { %>
              <form action="/unclaim" method="post" style="display:inline;">
                <input type="hidden" name="userEmail" value="<%= ue %>">
                <input type="hidden" name="slotId" value="<%= slot._id %>">
                <button type="submit" class="btn-ghost">Remove</button>
              </form>
              <span class="muted" style="margin-left:8px;">Claimed by you</span>
            <% } else { %>
              <span class="muted">Taken</span>
            <% } %>
          <% } %>
        </div>
      </div>
    <% }); %>
  </div>

</div>

<script>
  (function(){
    var q = document.getElementById('search');
    var spec = document.getElementById('specFilter');
    var onlyOpen = document.getElementById('onlyOpen');
    var cards = Array.from(document.querySelectorAll('#slotList .slot-card'));

    function getSelectedSpecs(){
      var out = [];
      var opts = spec ? spec.selectedOptions : [];
      for (var i=0; i<(opts ? opts.length : 0); i++) out.push(opts[i].value);
      return out;
    }

    function matchesFilters(card){
      var query = (q && q.value ? q.value : '').toLowerCase().trim();
      var hay = card.getAttribute('data-search') || '';
      if (query && hay.indexOf(query) === -1) return false;

      var selected = getSelectedSpecs();
      var s = card.getAttribute('data-spec') || '';
      if (selected.length && selected.indexOf(s) === -1) return false;

      var claimed = card.getAttribute('data-claimed');
      if (onlyOpen && onlyOpen.checked && claimed !== 'no') return false;

      return true;
    }

    function apply(){
      cards.forEach(function(c){ c.style.display = matchesFilters(c) ? '' : 'none'; });
    }

    if (q) q.addEventListener('input', apply);
    if (spec) spec.addEventListener('change', apply);
    if (onlyOpen) onlyOpen.addEventListener('change', apply);
    apply();
  })();
</script>

<%- include("./partials/footer"); -%>
