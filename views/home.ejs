<%- include("./partials/header"); -%>
<div id="view-shadow-slots">
  <% if(errM){%>
    <div class="alert alert-success">
      <h6 class="mb-0"><%=errM%>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </h6>
    </div>
  <%}%>
<% if (controls && controls.matchingLocked === true) { %>
  <h1>Your Matches</h1>
  <% var count = 0 %>
  <% slots.forEach(function(slot){ %>
    <% if(slot.studentEmail && slot.studentEmail == user.email){%>
      <% count++; %>
      <hr />
      <div class="row">
        <div class="col col-lg-12">
          <%= slot.physName %>, <%=slot.physSpecialty %> <br />
          <%= slot.dDate %>, <%= slot.timeStart %> to <%= slot.timeEnd %> <br />
          <%= slot.location %> <br />
          <% if(slot.notes){ %>
          <p class="italics">  Notes: <%= slot.notes %><br /></p>
          <% }%>
        </div>
      </div>
    <% } %>

  <% }) %>
  <hr />
  <br /><br />

  <h5>To confirm that you are willing and able to attend all the slots above, press this button. Please remember to check date and location information carefully. If you are unable to attend any of the slots above or have any questions about your slots, instead contact the Apollo Team via email immediately. </h5>
  <br /> 
  <!-- future todo: make confirm form disappear after student has confirmed once -->
  <form class="" action="/confirm" method="post">
    <input type="hidden" name="userEmail" value="<%=user.email%>">
    <p>I can attend all slots listed above: </p>
    <button type="submit" name="button" class="btn">Confirm</button>
  </form>
  
  <!-- <h4>Your matches are locked at this time. If you have any questions or concerns, please contact apolloyimde@gmail.com.</h4> -->


<% } else { %>
<h1>Your Matches</h1>
<% var count = 0 %>
<% slots.forEach(function(slot){ %>
  <% if(slot.studentEmail && slot.studentEmail == user.email){%>
    <% count++; %>
    <hr />
    <div class="row">
      <div class="col-12 col-md-9">
        <%= slot.physName %>, <%=slot.physSpecialty %> <br />
        <%= slot.dDate %>, <%= slot.timeStart %> to <%= slot.timeEnd %> <br />
        <%= slot.location %> <br />
        <% if(slot.notes){ %>
        <p class="italics">  Notes: <%= slot.notes %><br /></p>
        <% }%>
      </div>
      <div class="col-12 col-md-3">
        <form action="/unclaim" method="post">
          <input type="hidden" name="userEmail" value="<%=user.email%>">
          <input type="hidden" name="slotId" value="<%=slot._id%>">
          <br/>
          <button type="submit" name="button" class="btn">Remove</button>
        </form>
      </div>
    </div>
  <% } %>

<% }) %>
<hr /><br />
<% if(count<maxSlots){ %>
<h4>*You may claim an unlimited number of slots at this time. Any matches listed above are saved and Apollo will confirm your slots via email after the Match period.</h4>

<!-- <h4>*You may add up to <%=(maxSlots-count)%> match(es) at this time. Any matches above are saved and Apollo will confirm your slots via email after the Match period.</h4> -->
<% } else {%>
<h4>*You have the maximum number of matches at this time. Your above matches are saved and Apollo will confirm your slots via email after the Match period.</h4>
<% }%>
<!-- <h4>You may pick up to 1 slot at this time. Any matches listed above are saved and Apollo will confirm your slots via email before June 28.</h4> -->
<br /><br /><br /><br />

<%
  // sorted list of specialties from the slots rendered
  var specialties = [];
  slots.forEach(function(s){
    if (s.physSpecialty) {
      const spec = (s.physSpecialty || '').trim();
      if (specialties.indexOf(spec) === -1) specialties.push(spec);
    }
  });
  specialties.sort();
%>

<h1>Shadow Slots</h1><br/>
<!-- Filter Bar -->
<div style="margin: 0.5rem 0 1rem; padding: 0.75rem; background: #f8f8f8; border: 1px solid #ccc; border-radius:6px;">
  <div class="row">
    <div class="col-12 col-md-4" style="margin-bottom:.5rem;">
      <input id="slotSearch" class="form-control" placeholder="Search by physician or specialty">
    </div>

    <div class="col-12 col-md-5" style="margin-bottom:.5rem;">
      <label class="mb-1" for="specFilter">Specialties (choose one or more):</label>
      <select id="specFilter" class="form-control" multiple size="<%= Math.min(8, Math.max(3, specialties.length)) %>">
        <% specialties.forEach(function(spec){ %>
          <option value="<%= spec %>"><%= spec %></option>
        <% }) %>
      </select>
      <small style="opacity:.7;">Tip: Ctrl/Cmdâ€‘click to select multiple.</small>
    </div>

    <div class="col-6 col-md-2 d-flex align-items-center" style="margin-bottom:.5rem;">
      <label class="mb-0">
        <input id="onlyUnclaimed" type="checkbox" style="margin-right:6px;">
        Only unclaimed
      </label>
    </div>

    <div class="col-6 col-md-1 d-flex align-items-center" style="margin-bottom:.5rem;">
      <button id="resetFilters" type="button" class="btn btn-light w-100">Reset</button>
    </div>
  </div>
</div>


<% const pcpOnly = controls && controls.PCPonly === true; %>

<!-- <p>Please remember, all slots currently listed below fall under the category of Primary Care. More specialty slots will be available starting Wednesday, 10/20.</p><br/><br/> -->
<!-- <div class="container"> -->
  <div class="row chart-titles">
    <div class="col col-12 col-lg-2">
      Physician
    </div>
    <div class="col col-12 col-lg-2">
      Date
    </div>
    <div class="col col-12 col-lg-2">
      Time
    </div>
    <div class="col col-12 col-lg-2">
      Location
    </div>
    <div class="col col-12 col-lg-2">
      Notes
    </div>
    <div class="col col-12 col-lg-2">
      Matched?
    </div>
  </div>
<hr>
<% slots.forEach(function(slot){ %>
  <!-- !controls.PCPonly ||  -->
  <!-- slot.physSpecialty.includes("Primary Care") -->
  <% if(true){%>

<div class="row slot-row"
     data-phys="<%= (slot.physName || '').toLowerCase() %>"
     data-spec="<%= (slot.physSpecialty || '').toLowerCase() %>"
     data-filled="<%= (slot.studentEmail && slot.studentEmail.length>0) ? 'true' : 'false' %>">

      <div class="col col-12 col-lg-2">
        <%= slot.physName %>, <%=slot.physSpecialty %>
      </div>
      <div class="col col-12 col-lg-2">
        <%= slot.dDate %>
      </div>
      <div class="col col-12 col-lg-2">
       <%= slot.timeStart %> to <%= slot.timeEnd %>
      </div>
      <div class="col col-12 col-lg-2">
        <%= slot.location %>
      </div>
      <div class="col col-12 col-lg-2">
        <%= slot.notes %>
      </div>
      <div class="col col-12 col-lg-2">
        <% var btnProp = null; %>
        <% count >= maxSlots ? btnProp = "disabled" : null %>

        <% if (slot.studentEmail) { %>
          <% if (slot.studentEmail.length>0) { %>
          <p class="italics">Filled</p>
          <% } %>
        <% } else { %>
          <% if (pcpOnly && !slot.isPCP) { %>
          <!-- Show everything, but disable claiming during PCP only phase-->

            <button class="btn" disabled title="PCP-only Phase">Match</button>
            <small style="opacity:.7; margin-left:.5rem;">(PCP-only active)</small>
          <% } else { %>
          <!-- Normal claim form -->

            <form class="" action="/claim" method="post">
              <input type="hidden" name="userFName" value="<%=user.fName%>">
              <input type="hidden" name="userLName" value="<%=user.lName%>">
              <input type="hidden" name="userEmail" value="<%=user.email%>">
              <input type="hidden" name="slotId" value="<%=slot._id%>">
              <button type="submit" name="button" class="btn <%=btnProp%>" <%=btnProp%>>Match</button>
            </form>
          <% } %>
        <% } %>
      </div>
    </div>

<hr />
<% }}) %>
<%  } %>
</div>


<!-- filter logic -->

<script>
(function(){
  const q  = s => document.querySelector(s);
  const qa = s => Array.from(document.querySelectorAll(s));

  const search     = q('#slotSearch');
  const specSel    = q('#specFilter');
  const unclaimed  = q('#onlyUnclaimed');
  const resetBtn   = q('#resetFilters');
  const rows       = qa('.slot-row');

  function selectedSpecs() {
    return Array.from(specSel.selectedOptions).map(o => (o.value || '').toLowerCase());
  }

  function applyFilters() {
    const term = (search?.value || '').trim().toLowerCase();
    const specs = selectedSpecs(); // array of lowercased specialties
    const wantOnlyUnclaimed = !!(unclaimed && unclaimed.checked);

    rows.forEach(row => {
      const name = row.dataset.phys || '';
      const spec = row.dataset.spec || '';
      const isFilled = row.dataset.filled === 'true';

      let ok = true;

      if (term) {
        ok = name.includes(term) || spec.includes(term);
      }
      if (ok && specs.length > 0) {
        ok = specs.includes(spec);
      }
      if (ok && wantOnlyUnclaimed) {
        ok = !isFilled;
      }

      row.style.display = ok ? '' : 'none';
    });
  }

  function resetFilters() {
    if (search) search.value = '';
    if (specSel) Array.from(specSel.options).forEach(o => o.selected = false);
    if (unclaimed) unclaimed.checked = false;
    applyFilters();
  }

  search?.addEventListener('input', applyFilters);
  specSel?.addEventListener('change', applyFilters);
  unclaimed?.addEventListener('change', applyFilters);
  resetBtn?.addEventListener('click', resetFilters);

  applyFilters();
})();
</script>

<%- include("./partials/footer"); -%>
