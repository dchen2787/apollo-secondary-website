<%- include("./partials/header"); -%>
<style>
  .admin-wrap{display:grid;grid-template-columns:220px 1fr;gap:18px}
  @media(max-width:991px){.admin-wrap{grid-template-columns:1fr}}
  .cardish{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);margin-bottom:18px}
  .muted{color:#6b7280}
  .divider{height:1px;background:#e5e7eb;margin:10px 0}
  .nav a{display:block;padding:8px 10px;border-radius:8px;color:#111}
  .nav a:hover{background:#f7f7f7;text-decoration:none}
  .nav .active{background:#eef2ff}
</style>

<div class="container">
  <% if (errM && errM.length) { %>
    <div class="alert alert-info" style="margin:10px 0;"><%= errM %></div>
  <% } %>

  <div class="admin-wrap">
    <aside class="cardish" style="position:sticky;top:16px;align-self:start;">
      <h5 style="margin:0 0 8px 0;">Admin</h5>
      <div class="nav">
        <a href="/admin/students">Students</a>
        <a href="/admin/match" class="active">Match Controls</a>
      </div>
    </aside>

    <main>
      <!-- Match Settings -->
      <section class="cardish" id="sec-match">
        <h2 style="margin:0 0 10px;font-size:20px;">Match Settings</h2>
        <form action="/admin-matchSettings" method="post">
          <div class="form-group">
            <label>Phase:</label>
            <select class="form-control" name="phase" style="max-width:220px;">
              <option value="0" <%= controls && controls.phase===0 ? 'selected':'' %>>Phase 0 — View Only</option>
              <option value="1" <%= controls && controls.phase===1 ? 'selected':'' %>>Phase 1 — PCP Only</option>
              <option value="2" <%= controls && controls.phase===2 ? 'selected':'' %>>Phase 2 — Select up to 2</option>
              <option value="3" <%= (!controls || controls.phase===3) ? 'selected':'' %>>Phase 3 — Unlimited</option>
            </select>
          </div>

          <div class="form-group" style="margin-top:10px;">
            <label>Max Slots (used only if you apply a custom cap in future):</label>
            <input type="number" name="maxSlots" value="<%= maxSlots %>" class="form-control" style="max-width:200px;">
          </div>

          <div class="form-group" style="margin-top:10px;">
            <label>Matching Lock:</label><br/>
            <label style="margin-right:10px;">
              <input type="radio" name="matchingLock" value="true" <%= (controls && controls.matchingLocked) ? "checked" : "" %>> Locked (no new claims)
            </label>
            <label>
              <input type="radio" name="matchingLock" value="false" <%= (controls && !controls.matchingLocked) ? "checked" : "" %>> Unlocked
            </label>
          </div>

          <div style="margin-top:12px;">
            <label>Matching allowed for (Year/session joined, grad year)</label><br/>
            <% for (let i = 0; i < allGroups.length; i++) { %>
              <% var boxStatus = allGroups[i][1] ? "checked" : ""; %>
              <input type="checkbox" name="<%= allGroups[i][0] %>" <%= boxStatus %>>
              <%= allGroups[i][0] %><br/>
            <% } %>
          </div>

          <button type="submit" class="btn" style="margin-top:12px;">Update Access</button>
        </form>
      </section>

      <!-- Confirm Controls -->
      <section class="cardish" id="sec-confirms">
        <h2 style="margin:0 0 10px;font-size:20px;">Confirm Controls</h2>
        <form action="/admin-reset-confirms" method="post"
              onsubmit="return confirm('Reset ALL confirmations for everyone? This cannot be undone.');"
              style="margin-bottom:16px;">
          <button type="submit" class="btn btn-danger">Reset All Confirmations</button>
        </form>

        <h5>Confirm Status</h5>
        <% (confirms || []).forEach(function(confirm){ %>
          <div class="row" style="align-items:center;">
            <div class="col col-5"><%= confirm.email %></div>
            <div class="col col-3"><%= confirm.confirmed ? "true" : (typeof confirm.confirmed === "undefined" ? "-" : "false") %></div>
            <div class="col col-4">
              <form action="/admin-clear-confirm" method="post" style="display:inline;">
                <input type="hidden" name="email" value="<%= confirm.email %>">
                <button type="submit" class="btn btn-light"
                        onclick="return confirm('Clear confirmation for <%= confirm.email %>?');">
                  Clear
                </button>
              </form>
            </div>
          </div>
          <div class="divider"></div>
        <% }); %>
      </section>

      <!-- Shadow Slots -->
      <section class="cardish" id="sec-slots">
        <h2 style="margin:0 0 10px;font-size:20px;">Shadow Slots</h2>

        <div class="row row-head" style="font-weight:700;">
          <div class="col col-12 col-lg-2">Physician</div>
          <div class="col col-12 col-lg-2">Date</div>
          <div class="col col-12 col-lg-2">Time</div>
          <div class="col col-12 col-lg-2">Location</div>
          <div class="col col-12 col-lg-2">Notes</div>
          <div class="col col-12 col-lg-2">Matched?</div>
        </div>
        <div class="divider"></div>

        <% (slots || []).forEach(function(slot){ %>
          <div class="row">
            <div class="col col-12 col-lg-2"><%= slot.physName || '-' %><%= (slot.physSpecialty ? ', ' + slot.physSpecialty : '') %></div>
            <div class="col col-12 col-lg-2"><%= slot.dDate || '-' %></div>
            <div class="col col-12 col-lg-2"><%= (slot.timeStart || '-') %> to <%= (slot.timeEnd || '-') %></div>
            <div class="col col-12 col-lg-2"><%= slot.location || '-' %></div>
            <div class="col col-12 col-lg-2"><%= (slot.notes && slot.notes.trim()) ? slot.notes : '-' %></div>
            <div class="col col-12 col-lg-2">
              <% if (slot.studentEmail && slot.studentEmail.length) { %>
                <%= (slot.studentName || '') %><%= slot.studentName ? ' , ' : '' %><%= slot.studentEmail %>
              <% } else { %> - <% } %>
            </div>
          </div>
          <div class="divider"></div>
        <% }); %>
      </section>
    </main>
  </div>
</div>
<%- include("./partials/footer"); -%>
